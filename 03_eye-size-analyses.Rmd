---
editor_options: 
  chunk_output_type: console
---

# Eye size analyses 

In this script, we will compare the eye size estimates obtained using eBird photos with Ausprey & Stanley 2024's eye morphology dataset from preserved museum specimens.

## Install required libraries  

```{r}
library(tidyverse)
library(dplyr)
library(stringr)
library(vegan)
library(ggplot2)
library(scico)
library(data.table)
library(extrafont)
library(sf)
library(raster)
library(ggpubr)
```

## Loading the data

```{r}
species_traits <- read.csv ('data/species-trait-dat.csv') #to obtain the list of required species
eye_size_museum <- read.csv ('data/eye-size-museum.csv') #file with museum-derived eye size measurements
eye_size_ebird <- read.csv ('data/eye-size-ebird.csv') #file with eBird photo-derived eye size measurements
```

## Firstly, obtaining a list of species that are present and absent in the eye size dataset- this is only for our reference. Secondly, obtaining a list of i) species for which we are analyzing onset times and have eye size data (museum), and ii) species for which we are analyzing onset times and do not have eye size data (museum)
```{r}
#1
species_there <- data.frame (scientific_name = intersect (species_traits$scientific_name, eye_size_museum$species_jetz))
sp_list_on_A_S <- inner_join (species_traits, species_there, by = 'scientific_name') 
write.csv (sp_list_on_A_S, 'results/species_there_A_&_R.csv')

species_not_there <- data.frame (scientific_name = setdiff (species_traits$scientific_name, eye_size_museum$species_jetz))
sp_list_not_on_A_S <- inner_join (species_traits, species_not_there, by = 'scientific_name') 
write.csv (sp_list_not_on_A_S, 'results/species_not_there_A_&_R.csv')

#2
species <- data.frame (scientific_name = unique (begin_times$scientific_name))

species_there <- data.frame (scientific_name = intersect (species$scientific_name, eye_size_museum$species_jetz))
write.csv (species_there, 'results/species_in_acoustics_data_and_ausprey_ritland_data.csv')

species_not_there <- data.frame (scientific_name = setdiff (species$scientific_name, eye_size_museum$species_jetz))
write.csv (species_not_there, 'results/species_in_acoustics_data_not_in_ausprey_ritland_data.csv')
```

## Cleaning the eye size data obtained from eBird photos

```{r}
eye_size_ebird <- eye_size_ebird %>%
  rename (scientific_name = Species) %>% #renaming for easier analyses
  dplyr::select (scientific_name, Eye_Size_in_mm_averaged, Error_of_bill_ratio) %>% #retaining only select columns
  filter (!(scientific_name == 'Hypsipetes ganeesa')) %>%
  group_by (scientific_name) %>%
  slice_min (order_by = abs(Error_of_bill_ratio), n = 10) %>% #only selecting those estimates which have the least error ratios of all estimates
  summarize (mean_eye_size = mean(Eye_Size_in_mm_averaged)) %>% #obtaining the mean eye size measurements for our species
#shikra name change
  
  left_join (., species_traits, by = 'scientific_name') %>%
  dplyr::select (scientific_name, mean_eye_size, common_name, mass) %>% 
  mutate (rel_mean_eye_size = mean_eye_size/mass) %>% #calculating mean eye sizes relative to body mass for each species
  ungroup ()

write.csv (eye_size_ebird, "results/median_rel_eye_size_ebird.csv")
```

## Filtering the required species and obtaining the optical axial diameter measurements for each species (From Ausprey and Stanley's dataset)

```{r}
eye_size_museum <- eye_size_museum %>%
  rename (scientific_name = species_jetz) %>% #renaming for easier analyses
  dplyr::select (scientific_name, AD) %>% #retaining only select columns
  filter (scientific_name %in% eye_size_ebird$scientific_name) %>% #filtering the required species
  group_by (scientific_name) %>%
  summarize (mean_AD = mean (AD)) %>% #obtaining the mean axial diameter measurements for our species
 left_join (., species_traits, by = 'scientific_name') %>%
  dplyr::select (scientific_name, mean_AD, common_name, mass) %>% 
  mutate (rel_mean_AD = mean_AD/mass) %>% #calculating mean eye sizes relative to body mass for each species
  ungroup ()

write.csv (eye_size_museum, "results/median_rel_eye_size_museum.csv")
```

## Correlation between eye size estimates obtained from ebird and Ausprey & Stanley

```{r}
eye_size_estimates <- left_join (eye_size_ebird, eye_size_museum, by = c('scientific_name', 'common_name')) #combining both the data

cor_plot <- ggscatter(eye_size_estimates, x = 'rel_mean_AD', y = 'rel_mean_eye_size', 
          add = "reg.line", conf.int = TRUE, color = 'black',
          xlab = "Relative eye size estimates using Ausprey & Stanley 2024", ylab = "Relative eye size estimates using Macaulay Library", col = 'black', shape = 20, size = 10, label = 'common_name' , font.label = c(20, 'black'), 
          font.family = "Century Gothic", repel = TRUE) +
  stat_cor (method = 'spearman', label.x.npc = "left", label.y.npc = "top", color ='black', size = 15, family = "Century Gothic") +
  theme(text = element_text (family = "Century Gothic"),
  axis.text =  element_text (size = 25, family = "Century Gothic", colour = "black"),
  axis.title = element_text (size =25, family = "Century Gothic", colour = "black"))
```

## Conducting the linear regression between eye size estimates and measurements macaulay and body mass

```{r}
lm_ebird <- lm (log (mean_eye_size) ~ log (mass), data = eye_size_ebird) #linear regression between the logs of mean eye sizes and body mass for each species  
summary (lm_ebird) #to get the results 

predicted <- fitted (lm_ebird) #gives the predicted values 
residuals <- residuals (lm_ebird) #gives the residuals, i.e. the difference between the predicted and the actual value
lm_ebird_residuals <- as.data.frame (predicted) #creating a dataframe with the predicted
lm_ebird_residuals$ebird_residuals <- residuals #and the residual values


lm_museum <- lm (log (mean_AD) ~ log (mass), data = eye_size_museum)
summary (lm_museum)

predicted <- fitted (lm_museum)
residuals <- residuals (lm_museum)
lm_museum_residuals <- as.data.frame (predicted)
lm_museum_residuals$museum_residuals <- residuals

lm_results <- bind_cols (lm_museum_residuals, lm_ebird_residuals, eye_size_ebird) %>%
  dplyr::select (museum_residuals, ebird_residuals, scientific_name, common_name) #combining the residual values of the eye size estimates from macaulay and measurements from museum and adding the column of species to it

lm_results <- left_join (species_there, lm_results, by ='scientific_name') #only filtering those species for which we are analyzing onset times
```

## Conducting a correlation between the residual values of the estimates from photographs and museum measurements of species for which we are analyzing onset times

```{r}
cor_plot <- ggscatter(lm_results, x = 'museum_residuals', y = 'ebird_residuals', 
          add = "reg.line", conf.int = TRUE, color = 'black',
          xlab = "Relative eye size estimates using Ausprey & Stanley 2024", ylab = "Relative eye size estimates using Macaulay Library", col = 'black', shape = 20, size = 10, label = 'common_name' , font.label = c(20, 'black'), 
          font.family = "Century Gothic", repel = TRUE) +
  stat_cor (method = 'spearman', label.x.npc = "left", label.y.npc = "top", color ='black', size = 15, family = "Century Gothic") +
  theme(text = element_text (family = "Century Gothic"),
  axis.text =  element_text (size = 25, family = "Century Gothic", colour = "black"),
  axis.title = element_text (size =25, family = "Century Gothic", colour = "black"))
```



