---
editor_options: 
  chunk_output_type: console
---

# Eye size analyses 

In the first section of the script, we will compare the eye size estimates obtained using eBird photos with Ausprey & Ritland 2024's eye morphology dataset from preserved museum specimens. This is followed by the second section of the script where we will focus on obtaining mean eye size estimates from citizen-science photographs for all species in our study.

#Section I
## Install required libraries  

```{r}
library(tidyverse)
library(dplyr)
library(stringr)
library(vegan)
library(ggplot2)
library(scico)
library(data.table)
library(extrafont)
library(sf)
library(raster)
library(ggpubr)
```

## Loading the data

```{r}
species_traits <- read.csv ('data/species-trait-dat.csv') #to obtain the list of required species
eye_size_museum <- read.csv ('data/eye-size-museum.csv') #file with museum-derived eye size measurements
eye_size_ebird_AR <- read.csv ('data/eye-size-ebird-A&R.csv') #file with Macaulay photo-derived eye size estimated, for species for which we have comparable measurements from museum specimens
eye_size_ebird_not_in_AR <- read.csv ('data/eye-size-ebird-not-in-A&R.csv') #file with Macaulay photo-derived eye size estimates, for species for which we don't have comparable measurements from museum specimens
```

## Firstly, obtaining a list of species that are present and absent in the eye size dataset- this is only for our reference. Secondly, obtaining a list of i) species for which we are analyzing onset times and have eye size data (museum), and ii) species for which we are analyzing onset times and do not have eye size data (museum)

```{r}
#1
species_there <- data.frame (scientific_name = intersect (species_traits$scientific_name, eye_size_museum$species_jetz))
sp_list_on_A_S <- inner_join (species_traits, species_there, by = 'scientific_name') 

species_not_there <- data.frame (scientific_name = setdiff (species_traits$scientific_name, eye_size_museum$species_jetz))
sp_list_not_on_A_S <- inner_join (species_traits, species_not_there, by = 'scientific_name') 

#2
species <- data.frame (scientific_name = unique (species_traits$scientific_name))

species_there <- data.frame (scientific_name = intersect (species$scientific_name, eye_size_museum$species_jetz))
write.csv (species_there, 'results/species_in_acoustics_data_and_ausprey_ritland_data.csv')

species_not_there <- data.frame (scientific_name = setdiff (species$scientific_name, eye_size_museum$species_jetz))
write.csv (species_not_there, 'results/species_in_acoustics_data_not_in_ausprey_ritland_data.csv')
```

## Cleaning the eye size data obtained from eBird photos

```{r}
eye_size_ebird_AR <- eye_size_ebird_AR %>%
  rename (scientific_name = Species) %>% #renaming for easier analyses
  dplyr::select (scientific_name, Eye_Size_in_mm_averaged, Error_of_bill_ratio) %>% #retaining only select columns
 group_by (scientific_name) %>%
  slice_min (order_by = abs(Error_of_bill_ratio), n = 10) %>% #only selecting those estimates which have the least error ratios of all estimates
  summarize (mean_eye_size = mean(Eye_Size_in_mm_averaged)) %>% #obtaining the mean eye size measurements for our species
  left_join (., species_traits, by = 'scientific_name') %>%
  dplyr::select (scientific_name, mean_eye_size, common_name, mass) %>% 
  mutate (rel_mean_eye_size = mean_eye_size/mass) %>% #calculating mean eye sizes relative to body mass for each species
  ungroup ()
```

## Filtering the required species and obtaining the optical axial diameter measurements for each species (From Ausprey and Ritlands's dataset)

```{r}
eye_size_museum <- eye_size_museum %>%
  rename (scientific_name = species_jetz) %>% #renaming for easier analyses
  dplyr::select (scientific_name, AD) %>% #retaining only select columns
  filter (scientific_name %in% eye_size_ebird_AR$scientific_name) %>% #filtering the required species
  group_by (scientific_name) %>%
  summarize (mean_AD = mean (AD)) %>% #obtaining the mean axial diameter measurements for our species
 left_join (., species_traits, by = 'scientific_name') %>%
  dplyr::select (scientific_name, mean_AD, common_name, mass) %>% 
  mutate (rel_mean_AD = mean_AD/mass) %>% #calculating mean eye sizes relative to body mass for each species
  ungroup ()
```

## Conducting the linear regression between eye size estimates/measurements and body mass 

```{r}
lm_ebird <- lm (log (mean_eye_size) ~ log (mass), data = eye_size_ebird_AR) #linear regression between the logs of mean eye sizes and body mass for each species  
summary (lm_ebird) #to get the results 

predicted <- fitted (lm_ebird) #gives the predicted values 
residuals <- residuals (lm_ebird) #gives the residuals, i.e. the difference between the predicted and the actual value
lm_ebird_residuals <- as.data.frame (predicted) #creating a dataframe with the predicted
lm_ebird_residuals$ebird_residuals <- residuals #and the residual values


lm_museum <- lm (log (mean_AD) ~ log (mass), data = eye_size_museum)
summary (lm_museum)

predicted <- fitted (lm_museum)
residuals <- residuals (lm_museum)
lm_museum_residuals <- as.data.frame (predicted)
lm_museum_residuals$museum_residuals <- residuals

lm_results <- bind_cols (lm_museum_residuals, lm_ebird_residuals, eye_size_ebird_AR) %>%
  dplyr::select (museum_residuals, ebird_residuals, scientific_name, common_name) #combining the residual values of the eye size estimates from macaulay and measurements from museum and adding the column of species to it

lm_results <- left_join (species_there, lm_results, by ='scientific_name') %>% #only filtering those species for which we are analyzing onset times
  na.omit ()

write.csv (lm_results, 'results/eye_size_residuals.csv')
```

## Conducting a correlation between the residual values from the linear regressions between estimates or measurements and body mass

```{r}
cor_plot <- ggscatter(lm_results, x = 'museum_residuals', y = 'ebird_residuals', 
          add = "reg.line", conf.int = TRUE, color = 'black',
          xlab = "Relative eye size estimates using Ausprey & Stanley 2024", ylab = "Relative eye size estimates using Macaulay Library", col = 'black', shape = 20, size = 10, label = 'common_name' , font.label = c(20, 'black'), 
          font.family = "Century Gothic", repel = TRUE) +
  stat_cor (method = 'spearman', label.x.npc = "left", label.y.npc = "top", color ='black', size = 15, family = "Century Gothic") +
  theme(text = element_text (family = "Century Gothic"),
  axis.text =  element_text (size = 25, family = "Century Gothic", colour = "black"),
  axis.title = element_text (size =25, family = "Century Gothic", colour = "black"))

cor_plot #to inspect the visualization

#to save the plot
ggsave(cor_plot,
  filename = "figs/cor_plot.png",  
  width    = 15,
  height   = 12,
  units    = "in",
  dpi      = 300
)
dev.off()
```

#This plot shows a highly significant positive correlation (R = 0.79, p < 0.05) between the residuals of eye size estimates from citizen-science-derived photographs and measurements from museum specimens. Thus, we extend the methodology of estimating eye size estimates from photographs to species for which we do not have comparable museum-based data.

#Section II
## Cleaning the eye size data (data for species with no comparable data)

```{r}
species_traits <- species_traits %>%
  mutate(scientific_name = recode(scientific_name, "Iole indica" = "Acritillas indica")) #updating the scientific name of yellow-browed bulbul

eye_size_ebird_not_in_AR <- eye_size_ebird_not_in_AR %>%
  na.omit () %>%
  filter (!common_name %in% c("Red-wattled Lapwing", "Spotted Dove", "Malabar Parakeet", "Vernal Hanging-Parrot", "Plum-headed Parakeet", "Malabar Gray Hornbill")) %>% #removing species for which either the error rates are too high, or eye sizes are not possible to obtain using photographs
  rename (scientific_name = species) %>% 
  dplyr::select (scientific_name, Eye_Size_in_mm_averaged, Error_of_bill_ratio) %>% 
  group_by (scientific_name) %>%
  mutate (Error_of_bill_ratio = as.numeric (Error_of_bill_ratio), Eye_Size_in_mm_averaged = as.numeric (Eye_Size_in_mm_averaged)) %>% #converting into numeric class
  slice_min (order_by = abs(Error_of_bill_ratio), n = 10) %>% 
  summarize (mean_eye_size = mean(Eye_Size_in_mm_averaged)) %>% 
  left_join (., species_traits, by = 'scientific_name') %>%
  dplyr::select (scientific_name, mean_eye_size, common_name, mass) %>% 
  mutate (rel_mean_eye_size = mean_eye_size/mass) %>% 
  ungroup ()
```

## Combining both the eye size dataframes

```{r}
eye_size_ebird <- bind_rows (eye_size_ebird_AR, eye_size_ebird_not_in_AR)

write.csv (eye_size_ebird, 'results/eye_size_ebird.csv')
```

