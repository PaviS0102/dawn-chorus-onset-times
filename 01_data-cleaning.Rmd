---
editor_options: 
  chunk_output_type: console
---

# Data cleaning  

In this script, we will clean the data and create one sheet for both the seasons.  

## Install required libraries  

```{r}
library(tidyverse)
library(dplyr)
library(stringr)
library(vegan)
library(ggplot2)
library(scico)
library(data.table)
library(extrafont)
library(sf)
library(raster)
```

## Loading acoustic data and cleaning the data 

The acoustic data consists of annotations of first vocalizations of species in the dawn chorus. Herein, we only consider a subset of the acoustic data from 6 to 10 am. The following code is to clean the data and arrive at a single master sheet of annotations. 
(Note: The data from summer doesn't have any notes about rain.)

```{r}
#reading and combining selection tables 
summer_directory <- "C:/Users/pavit/OneDrive/Desktop/PD_WG_Project/ANH_restoration/dawn-chorus-onset-times/data/summer_dawn_chorus"
file_list <- list.files (summer_directory, pattern = "\\.txt$", full.names = TRUE, recursive = TRUE) #calling the txt files
txt_files <- lapply(file_list, read.table, header = TRUE, sep = "\t") #to read each txt file 
summer_data <- do.call(bind_rows, txt_files) #combining all of them to create a single dataframe

#extracting site_code from begin.path and renaming the columns
summer_data<- summer_data %>% 
  separate_wider_delim(Begin.Path, delim = "\\", names = c("drive", "season", "site_code", "date_site"),  cols_remove = FALSE) %>% #splitting the begin path to 4 columns: drive, season (+year), site_code, date_site
  separate_wider_delim(season, delim = '-', names = c("year", "season")) %>% #extracting a separate column for season
  dplyr::select(-End.Date, -year, -drive, -Min.Amp..U., -Max.Amp..U., Peak.Amp..U.) %>% #removing unwanted columns
  rename (., begin_time = Begin.Time..s., end_time = End.Time..s., low_Freq = Low.Freq..Hz., high_freq = High.Freq..Hz., file_offset = File.Offset..s., peak_freq = Peak.Freq..Hz., center_freq = Center.Freq..Hz., delta_freq = Delta.Freq..Hz., BW_90 = BW.90...Hz., delta_time = Delta.Time..s., dur_90 = Dur.90...s., date = Begin.Date, begin_clock_time = Begin.Clock.Time, end_clock_time = End.Clock.Time, filename = date_site) #renaming the columns

#arranging by time and then removing duplicates (multiple annotations of the same species at the same site and day)
summer_data <- summer_data %>% 
  group_by (site_code, date) %>%
  arrange (begin_clock_time) %>% #arranging by the time so that a species' first vocalization comes first
  filter(!duplicated(species)) #then filtering out the ones which come later 

#interchanging GRNW (green warbler) with GRWA (greenish warbler)
summer_data <- summer_data %>%
  mutate (species = case_when (species == 'GRNW' ~ 'GRWA', 
                               species == 'GRWA' ~ 'GRNW',
                               TRUE ~ species)) #keep other species unchanged


# Repeating the above steps with the winter data:

#reading and combining selection tables 
winter_directory <- "C:/Users/pavit/OneDrive/Desktop/PD_WG_Project/ANH_restoration/dawn-chorus-onset-times/data/winter_dawn_chorus"
file_list <- list.files (winter_directory, pattern = "\\.txt$", full.names = TRUE, recursive = TRUE) 
txt_files <- lapply(file_list, read.table, header = TRUE, sep = "\t") 
winter_data <- do.call(bind_rows, txt_files) 

#extracting site_code from begin.path and renaming the columns
winter_data<- winter_data %>% 
  separate_wider_delim(Begin.Path, delim = "\\", names = c("drive", "season", "site_code", "date_site"), cols_remove = FALSE) %>% 
  separate_wider_delim(season, delim = '-', names = c("year", "season")) %>% 
  dplyr::select(-End.Date, -year, -drive, -Min.Amp..U., -Max.Amp..U., Peak.Amp..U.) %>% 
  rename (., begin_time = Begin.Time..s., end_time = End.Time..s., low_Freq = Low.Freq..Hz., high_freq = High.Freq..Hz., file_offset = File.Offset..s., peak_freq = Peak.Freq..Hz., center_freq = Center.Freq..Hz., delta_freq = Delta.Freq..Hz., BW_90 = BW.90...Hz., delta_time = Delta.Time..s., dur_90 = Dur.90...s., date = Begin.Date, begin_clock_time = Begin.Clock.Time, end_clock_time = End.Clock.Time, filename = date_site) 


#arranging by time and then removing duplicates (multiple annotations of the same species at the same site and day)
winter_data <- winter_data %>% 
  group_by (site_code, date) %>%
  arrange (begin_clock_time) %>% 
  filter(!duplicated(species)) 

#interchanging GRNW (green warbler) with GRWA (greenish warbler)
winter_data <- winter_data %>%
  mutate (species = case_when (species == 'GRNW' ~ 'GRWA', 
                               species == 'GRWA' ~ 'GRNW',
                               TRUE ~ species)) 
```

## Combining the data from both the seasons

```{r}
data <- bind_rows (summer_data, winter_data) #final data

uk_annotations <- data %>%
  filter (species == 'UK')

write.csv (uk_annotations, 'uk_annotations.csv')
```

